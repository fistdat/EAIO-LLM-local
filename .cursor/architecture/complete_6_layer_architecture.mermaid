graph TB
    %% EAIO Complete 6-Layer Architecture v2.1
    %% Enhanced with BDG2 integration and performance metrics
    %% Fixed Mermaid syntax errors and optimized structure
    
    subgraph Layer1 ["🖥️ Layer 1: User Interface Layer"]
        direction TB
        NextJS["Next.js Web App<br/>📊 Executive Dashboard<br/>📈 Manager Dashboard<br/>🔧 Analyst Dashboard<br/>⚡ SSR + ISR Optimized<br/>🔄 Real-time WebSocket"]
        Streamlit["Streamlit Analytics<br/>📊 Deep Analytics<br/>🔍 BDG2 Exploration<br/>📈 Custom Reports<br/>🎯 Data Science Interface<br/>🧪 Interactive Notebooks"]
        PWA["Progressive Web App<br/>📱 Mobile Interface<br/>🔔 Real-time Alerts<br/>⚡ Offline Capability<br/>🌐 Cross-platform Support<br/>📍 Location-aware"]
        NextJS -.-> PWA
        Streamlit -.-> PWA
    end
    
    subgraph Layer2 ["🧠 Layer 2: Hybrid LLM Infrastructure"]
        direction TB
        HybridRouter["Hybrid LLM Router<br/>🔒 Privacy Classification<br/>💰 Cost Optimization<br/>🔄 Auto Fallback<br/>🎯 Intelligent Routing<br/>⚖️ Load Balancing"]
        
        subgraph LocalLLM ["Local LLM Stack - M1 Optimized"]
            Ollama["Ollama Runtime<br/>🏠 On-device Processing<br/>🚀 M1 Neural Engine<br/>💾 16GB RAM Optimized"]
            Qwen["Qwen2.5-7B-Instruct<br/>🎯 Control & Safety<br/>⚡ Sub-second Response<br/>🛡️ Safety Validation"]
            Llama["Llama-3.2-3B-Instruct<br/>⚡ Fast Coordination<br/>🔄 Real-time Processing<br/>📊 Pattern Recognition"]
        end
        
        subgraph ExternalAPI ["External LLM APIs"]
            OpenAI["OpenAI GPT-4o<br/>🧠 Complex Reasoning<br/>📊 Strategic Analysis<br/>💡 Advanced Problem Solving"]
            DeepSeek["DeepSeek-V3<br/>💡 Optimization Strategy<br/>🔬 Advanced Reasoning<br/>⚡ 2024 State-of-art"]
            Gemini["Google Gemini<br/>📊 Data Analysis<br/>🌍 Multimodal Processing<br/>🔍 Pattern Analysis"]
        end
        
        HybridRouter --> LocalLLM
        HybridRouter --> ExternalAPI
    end
    
    subgraph Layer3 ["🔌 Layer 3: MCP Integration Layer ⭐ NEW"]
        direction TB
        
        subgraph MCPServers ["MCP Server Ecosystem"]
            EnergyMCP["Energy Data Server<br/>⚡ Consumption Data<br/>📊 Sensor Readings<br/>🚨 Anomaly Detection<br/>⏱️ 30s Timeout<br/>🔄 5min Cache TTL"]
            WeatherMCP["Weather Server<br/>🌤️ Forecast Data<br/>📈 Historical Weather<br/>🌡️ Impact Analysis<br/>⏱️ 15s Timeout<br/>🔄 30min Cache TTL"]
            MLMCP["ML Models Server<br/>🤖 Forecasting Models<br/>📊 Efficiency Calculation<br/>💡 Optimization Recommendations<br/>⏱️ 45s Timeout<br/>🔄 15min Cache TTL"]
            ControlMCP["Building Control Server<br/>🏢 HVAC Control<br/>💡 Lighting Optimization<br/>⚙️ Equipment Scheduling<br/>⏱️ 60s Timeout<br/>🔄 1min Cache TTL"]
            BDG2MCP["BDG2 Data Server<br/>🏢 1,636 Building Benchmarks<br/>📊 Performance Comparison<br/>📈 Pattern Analysis<br/>⏱️ 20s Timeout<br/>🔄 2h Cache TTL"]
        end
        
        MCPCache["MCP Tool Cache<br/>⚡ Redis Caching<br/>🎯 Category-based TTL<br/>📊 Performance Monitor<br/>🚀 >85% Hit Ratio Target<br/>⚡ Sub-second Retrieval"]
        MCPServers --> MCPCache
    end
    
    subgraph Layer4 ["🤖 Layer 4: Multi-Agent Framework ⭐ NEW"]
        direction TB
        
        subgraph LangGraphCore ["LangGraph Orchestration"]
            StateGraph["StateGraph Workflow<br/>🔄 State Management<br/>🛡️ Checkpointing<br/>↩️ Recovery Mechanism<br/>📊 Workflow Tracing<br/>🎯 Conditional Routing"]
            WorkflowStates["Workflow States<br/>💬 Messages State<br/>🏢 Building Context<br/>📊 Analysis Results<br/>🧠 Memory Context<br/>⚡ Performance Tracking<br/>🔍 Token Usage"]
        end
        
        subgraph AgentNetwork ["5-Agent Specialized Network"]
            CoordAgent["Coordinator Agent<br/>🎯 Workflow Orchestration<br/>📋 Task Distribution<br/>🔄 Result Integration<br/>🧠 Llama-3.2-3B<br/>💭 Working Memory"]
            DataAgent["Data Intelligence Agent<br/>📊 BDG2 Analysis & Patterns<br/>🔍 Pattern Recognition<br/>📈 Historical Insights<br/>🧠 Llama-3.2-3B<br/>💾 Episodic Memory"]
            OptAgent["Optimization Strategist<br/>💡 Strategy Development<br/>⚡ Energy Optimization<br/>💰 Cost-Benefit Analysis<br/>🧠 DeepSeek-V3<br/>💭 Working + Episodic"]
            ForecastAgent["Forecast Intelligence<br/>📈 Predictive Modeling<br/>🌤️ Weather Integration<br/>📊 Trend Analysis<br/>🧠 Hybrid Routing<br/>💾 Episodic Memory"]
            ControlAgent["Control Coordination<br/>🏢 System Control<br/>⚙️ Equipment Management<br/>🛡️ Safety Validation<br/>🧠 Qwen2.5-7B<br/>⚡ Short-term Memory"]
        end
        
        LangSmith["LangSmith Monitoring<br/>📊 Workflow Tracing<br/>💰 Cost Tracking<br/>⚡ Performance Metrics<br/>🔍 Agent Analytics<br/>📈 Real-time Dashboards"]
        
        StateGraph --> AgentNetwork
        AgentNetwork --> LangSmith
    end
    
    subgraph Layer5 ["🧠 Layer 5: Memory Systems ⭐ NEW"]
        direction TB
        
        subgraph MemoryLayers ["5-Layer Memory Architecture"]
            ShortTerm["Short-term Memory<br/>💭 Redis Cache<br/>🔄 20 Exchanges<br/>⚡ Immediate Context<br/>⏰ 2h TTL<br/>🚀 Microsecond Access"]
            Working["Working Memory<br/>🧠 Redis Buffer<br/>📝 2000 Tokens<br/>🎯 Task Context<br/>📊 Conversation Summary<br/>🔄 Real-time Updates"]
            Episodic["Episodic Memory<br/>🏢 Milvus Vectors<br/>📊 Building Patterns<br/>💡 Experience Storage<br/>🔍 384D Embeddings<br/>⚡ <50ms Search"]
            Semantic["Semantic Memory<br/>📚 ChromaDB<br/>🎓 Domain Knowledge<br/>📊 BDG2 Benchmarks<br/>🧠 Knowledge Base<br/>🔍 Similarity Search"]
            Procedural["Procedural Memory<br/>⚙️ PostgreSQL<br/>🛠️ Agent Skills<br/>📋 Procedures<br/>🔧 Automation Rules<br/>📈 Success Tracking"]
        end
        
        MemoryManager["Memory Manager<br/>🔄 Consolidation Process<br/>🎯 Context Retrieval<br/>📊 Pattern Extraction<br/>🧠 Cross-Memory Queries<br/>🔄 Weekly Optimization"]
        MemoryLayers --> MemoryManager
    end
    
    subgraph Layer6 ["💾 Layer 6: Data Infrastructure Layer"]
        direction TB
        
        subgraph PrimaryDB ["Primary Database - Enterprise Grade"]
            PostgreSQL["PostgreSQL 16<br/>🏢 Building Metadata<br/>👥 User Management<br/>🔐 Security Context<br/>🔗 ACID Compliance<br/>⚡ <100ms Queries"]
            TimescaleDB["TimescaleDB Extension<br/>⚡ Energy Time-series<br/>📊 BDG2 Integration<br/>🚀 Optimized Queries<br/>📈 53.6M+ Data Points<br/>🗜️ Compression Enabled"]
        end
        
        subgraph VectorDB ["Vector Database - Production Scale"]
            Milvus["Milvus Vector DB<br/>🔍 Similarity Search<br/>🧠 Agent Memory<br/>📊 Pattern Storage<br/>🎯 384D Embeddings<br/>⚡ <50ms Search<br/>🔗 HNSW Indexing"]
        end
        
        subgraph CacheLayer ["High-Performance Cache"]
            Redis["Redis Cache<br/>⚡ Session Storage<br/>🔄 Real-time Updates<br/>📊 Performance Cache<br/>🚀 Memory Operations<br/>💾 Persistent Backup"]
        end
        
        PostgreSQL -.-> TimescaleDB
    end
    
    %% Layer Connections - Primary Flow
    Layer1 --> Layer2
    Layer2 --> Layer3
    Layer3 --> Layer4
    Layer4 --> Layer5
    Layer5 --> Layer6
    
    %% Cross-layer Integrations - Bidirectional
    Layer4 -.-> Layer3
    Layer5 -.-> Layer6
    Layer1 -.-> Layer6
    
    %% Real-time Data Flows - Reverse Flow
    Layer6 -.-> Layer5
    Layer5 -.-> Layer4
    Layer4 -.-> Layer3
    Layer3 -.-> Layer2
    Layer2 -.-> Layer1
    
    %% Performance Annotations
    Layer1 -.-> |"<1s Load Time"| Layer2
    Layer2 -.-> |"Sub-second Response"| Layer3
    Layer3 -.-> |"<5s Tool Response"| Layer4
    Layer4 -.-> |"<3min Analysis"| Layer5
    Layer5 -.-> |"<50ms Memory"| Layer6
    
    %% Styling with Enhanced Colors
    classDef layerStyle fill:#f9f9f9,stroke:#333,stroke-width:2px,color:#333
    classDef newFeature fill:#e1f5fe,stroke:#0277bd,stroke-width:3px,color:#01579b
    classDef coreComponent fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#e65100
    classDef infrastructure fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#4a148c
    classDef performance fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#1b5e20
    
    class Layer1,Layer2,Layer3,Layer4,Layer5,Layer6 layerStyle
    class Layer3,Layer4,Layer5 newFeature
    class NextJS,Streamlit,HybridRouter,StateGraph,MemoryManager coreComponent
    class PostgreSQL,Milvus,Redis infrastructure
    class TimescaleDB,MCPCache,LangSmith performance 